{% extends 'base.html' %}
{% block content %}
  <div class="container">

    <h1>Office Chess</h1>
    <h2>Welcome {{ name }}!</h2>

    <div id="myBoard"></div>
    <div id="status"></div>

    <div class="info-box">
      <div>FEN: <span id="fenSpan"></span></div>
      <div>PGN: <span id="pgnSpan"></span></div>
    </div>

    <button onclick="resetGame()">Reset Game</button>

    <script>
      // Pull initial FEN from the server-side template variable
      const initialFen = "{{ fen }}";

      // Initialize the Chessboard2
      const board = Chessboard2('myBoard', {
        position: initialFen,
        draggable: true,
        dropOffBoard: 'snapback',
        pieceTheme: 'static/chesspieces/wikipedia/{piece}.png',

        // ================================
        //  onDragStart: highlight moves
        // ================================
        onDragStart: function(dragData) {
          // Clear any old circles
          board.clearCircles();

          // Extract square & piece from dragData
          let fromSquare = dragData.square;
          let piece = dragData.piece;
          console.log(`Dragging piece ${piece} from square ${fromSquare}`);

          // If there's no valid square or piece, bail out
          if (!fromSquare || !piece) return;

          // Ask the server for all possible destination squares
          $.post('/legal_moves', { square: fromSquare }, function(res) {
            if (res && res.moves) {
              console.log(`Server responded with moves:`, res.moves);
              // Add circles for each valid destination
              res.moves.forEach(destSquare => {
                board.addCircle(destSquare);  // default circle
              });
            } else {
              console.log('No moves returned from /legal_moves');
            }
          }).fail(function() {
            console.error('Failed to retrieve legal moves from server');
          });
        },

        // ================================
        //  onDrop: make the move
        // ================================
        onDrop: function(dropData) {
          // Remove circles
          board.clearCircles();

          // Build a UCI-like string, e.g. "e2e4"
          let moveStr = dropData.source + dropData.target;

          $.post('/make_move', { move: moveStr }, function(data) {
            if (data.status === 'ok') {
              board.position(data.fen);
              updateStatus();
            } else {
              // If server says illegal or error => revert
              document.getElementById('status').innerText = data.message;
            }
          }).fail(function() {
            board.position(dropData.oldPos);
            document.getElementById('status').innerText = "Server error, move not processed.";
          });

          return 'snapback';
        }
      });

      // Connect to Socket.IO
      const socket = io(location.origin, { path: '/socket.io' });

      // Listen for "board_update" events from the server
      socket.on('board_update', function(data) {
        console.log("Received board_update from server:", data);
        // data.fen, data.pgn, data.statusText
        if (board) {
          board.position(data.fen);
        }
        updateStatus();
      });

      // Refresh the game status (FEN, PGN, etc.)
      function updateStatus() {
        $.get('/game_status', function(data) {
          if (data) {
            document.getElementById('status').innerText = data.statusText;
            document.getElementById('fenSpan').innerText = data.fen;
            document.getElementById('pgnSpan').innerText = data.pgn;
          }
          if (board) {
            const newOrientation = board.orientation(data.orientation)
            console.log('New board orientation is:', newOrientation)
            console.log('New board orientation is:', data.orientation)
          }
        });
      }

      // Reset the board (call server /reset)
      function resetGame() {
        window.location.href = "/reset";
      }

      // On page load, get initial status
      updateStatus();
    </script>
  </div>
{% endblock %}
